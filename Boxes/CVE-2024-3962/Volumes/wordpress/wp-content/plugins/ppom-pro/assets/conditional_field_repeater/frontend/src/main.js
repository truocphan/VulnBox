import { rename_ids } from '../../../repeater/frontend/src/utilities';

const handleMagicTag = (fieldWrapper, tagValues) => {
    const label = fieldWrapper.find('label.form-control-label');

    for( const [tagName, value] of Object.entries( tagValues ) ) {
        label.text(label.text().replace(`{${tagName}}`, value));
    }
}

jQuery(document).ready(($) => {
    $('.ppom-wrapper .ppom-field-wrapper').each((i, fieldWrapper) => {
        const jFieldWrapper = $(fieldWrapper);
        const repeaterOriginDataName = jFieldWrapper.find('.ppom-input').data('cfr_origin');

        if( ! repeaterOriginDataName ) {
            return;
        }

        const originInput = ppom_input_vars.ppom_inputs.find(field=>field.data_name===repeaterOriginDataName);

        if( ! originInput ) {
            return;
        }

        const hasMultipleOrigin =  ['quantities', 'qtypack'].includes( originInput.type );

        // Hide the the first field.
        jFieldWrapper.hide();

        const repeaterOriginSelector = `input[data-data_name="${repeaterOriginDataName}"]`;

        // Setup listener for the origin of the repeater.
        $(repeaterOriginSelector).on('input', (e)=>{
            const originGroup = e.target.id;

            const originEl = $(e.target);

            // Reset the current cloned fields of the data name.
            $(`.ppom-field-wrapper[data-clone_origin_group="${originGroup}"]`).remove();

            // Represents the fieldWrapper clones will be how many.
            const repeater = e.target.value;

            // Clone the fieldWrapper element the across the repeater.
            for( let repeatNo = 1; repeatNo <= repeater; repeatNo++) {
                const clonedField = jFieldWrapper.clone().show().appendTo(jFieldWrapper.parent());

                const uniqCloneIdentifier = hasMultipleOrigin ? `${originEl.data('optionid')}${ppomCfr.CONST_MULTIPLE_ORIGIN_IDENTIFIER}${repeatNo}` : `${repeatNo}`;

                // Handle magic tag
                handleMagicTag(clonedField, {
                    'repeatNumber': repeatNo,
                    'optionTitle': originEl.data('label')
                });

                clonedField.attr('data-clone_origin_group', originGroup);

                // Add __clone suffix to needed stuff.
                rename_ids(clonedField, uniqCloneIdentifier, ()=>{});
            }
        });

    });
});